{% extends "admin_pages/base.html" %}
{% load static %}

{% block title %}{% if room %}Edit{% else %}Add{% endif %} Room Category | Admin Dashboard{% endblock %}

{% block content %}
<div class="dashboard sp_bottom_100">
    <div class="container-fluid full__width__padding">
        <div class="dashboard__section__title">
            <h4 class="mb-0">{% if room %}Edit{% else %}Add{% endif %} Room Category</h4>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                
                {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert" style="border-left: 5px solid #dc3545; background-color: #fff5f5; color: #842029;">
                    <h5 class="alert-heading" style="font-size: 1rem;"><i class="fas fa-exclamation-circle"></i> Please correct the errors below:</h5>
                    <ul class="mb-0 mt-2">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                <form method="post" enctype="multipart/form-data" class="form-wrapper" id="roomForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label">Select Property <span class="text-danger">*</span></label>
                            {{ form.property }}
                        </div>

                        <div class="col-md-6 mb-4">
                            <label class="form-label">Room Category Name <span class="text-danger">*</span></label>
                            {{ form.name }}
                        </div>

                        <div class="col-md-6 mb-4">
                            <label class="form-label">Price Per Night (â‚¹) <span class="text-danger">*</span></label>
                            {{ form.price_per_night }}
                        </div>

                        <div class="col-md-6 mb-4">
                            <label class="form-label">Max Occupancy</label>
                            {{ form.max_occupancy }}
                        </div>

                        <div class="col-12 mb-4">
                            <label class="form-label">Room Image <span class="text-danger">*</span></label>
                            {{ form.image }}
                            {% if form.instance.image %}
                                <div class="mt-2 p-2 border rounded bg-light d-inline-block">
                                    <small class="d-block text-muted mb-1">Current Image:</small>
                                    <img src="{{ form.instance.image.url }}" style="height: 100px; object-fit: cover; border-radius: 5px;">
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-12 mb-4">
                            <label class="form-label">Description </label>
                            {{ form.description }}
                        </div>

                        <div class="col-12 mt-4">
                            <div class="dashboard__form__button">
                                <button type="submit" class="default__button">Save Room Category</button>
                                <a href="{% url 'admin_pages:room_list' %}" class="default__button" style="background: #6c757d;">Cancel</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const textarea = document.querySelector('textarea[name="description"]');
    const form = document.getElementById('roomForm');

    if (textarea && form) {
        ClassicEditor.create(textarea, {
            toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'blockQuote', 'undo', 'redo'],
            placeholder: 'Write a detailed description of the room amenities and features...'
        }).then(editor => {
            // CRITICAL FIX: Sync data to textarea BEFORE form submits
            form.addEventListener('submit', function() {
                textarea.value = editor.getData();
            });

            // Handle image uploads inside the editor (optional)
            editor.plugins.get('FileRepository').createUploadAdapter = loader => ({
                upload: () => loader.file.then(file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve({ default: reader.result });
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                })),
                abort: () => {}
            });
        }).catch(console.error);
    }
});
</script>

{% endblock %}

{% block extra_css %}
<style>
    /* Uniform input styling */
    input[type="text"], 
    input[type="number"], 
    input[type="file"], 
    select, 
    textarea {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 0.85rem 1rem;
        margin-top: 5px;
        background-color: #fff;
    }

    input:focus, select:focus, textarea:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    /* CKEditor specific styling */
    .ck.ck-editor__editable {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        border-radius: 0 0 8px 8px !important;
    }
    
    .ck.ck-toolbar {
        border-radius: 8px 8px 0 0 !important;
    }
</style>
{% endblock %}